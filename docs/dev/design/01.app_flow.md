# Luồng ứng dụng AI Parking

Tài liệu này mô tả chi tiết các luồng ứng dụng AI Parking, từ khi người dùng mở ứng dụng đến khi hoàn thành các tác vụ chính.

## 1. Luồng người dùng cuối (End User)

### 1.1. Đăng ký và đăng nhập

```mermaid
sequenceDiagram
    participant User as Người dùng
    participant App as Ứng dụng
    participant Backend as Backend API
    participant DB as Database
    
    User->>App: Mở ứng dụng
    App->>User: Hiển thị màn hình chào mừng
    User->>App: Chọn "Đăng ký"
    App->>User: Hiển thị form đăng ký
    User->>App: Nhập thông tin đăng ký
    App->>Backend: Gửi thông tin đăng ký
    Backend->>DB: Lưu thông tin người dùng
    Backend->>User: Gửi mã xác thực (email/SMS)
    User->>App: Nhập mã xác thực
    App->>Backend: Gửi mã xác thực
    Backend->>App: Xác nhận đăng ký thành công
    App->>User: Hiển thị màn hình đăng nhập
    User->>App: Nhập thông tin đăng nhập
    App->>Backend: Gửi thông tin đăng nhập
    Backend->>App: Trả về token và thông tin người dùng
    App->>User: Hiển thị màn hình chính
```

### 1.2. Tìm kiếm và đặt chỗ đỗ xe

```mermaid
sequenceDiagram
    participant User as Người dùng
    participant App as Ứng dụng
    participant Backend as Backend API
    participant Map as Map Service
    participant Payment as Payment Gateway
    
    User->>App: Truy cập màn hình tìm kiếm
    App->>Backend: Yêu cầu vị trí hiện tại
    Backend->>Map: Truy vấn bãi đỗ xe gần nhất
    Map->>Backend: Trả về danh sách bãi đỗ xe
    Backend->>App: Trả về danh sách bãi đỗ xe
    App->>User: Hiển thị danh sách/bản đồ bãi đỗ
    User->>App: Chọn bãi đỗ xe
    App->>Backend: Yêu cầu thông tin chi tiết
    Backend->>App: Trả về thông tin chi tiết
    App->>User: Hiển thị thông tin chi tiết bãi đỗ
    User->>App: Chọn đặt chỗ và thời gian
    App->>Backend: Gửi yêu cầu đặt chỗ
    Backend->>App: Xác nhận đặt chỗ
    App->>User: Hiển thị màn hình thanh toán
    User->>App: Chọn phương thức thanh toán
    App->>Payment: Xử lý thanh toán
    Payment->>App: Xác nhận thanh toán thành công
    App->>Backend: Cập nhật trạng thái đặt chỗ
    Backend->>App: Trả về thông tin đặt chỗ
    App->>User: Hiển thị xác nhận đặt chỗ
    App->>User: Hiển thị chỉ dẫn đến bãi đỗ
```

### 1.3. Sử dụng bãi đỗ xe

```mermaid
sequenceDiagram
    participant User as Người dùng
    participant App as Ứng dụng
    participant Backend as Backend API
    participant Staff as Nhân viên bãi đỗ
    participant LPR as Hệ thống nhận diện biển số
    
    User->>Staff: Đến bãi đỗ xe
    Staff->>App: Quét mã QR hoặc thẻ NFC
    App->>Backend: Gửi thông tin check-in
    Backend->>LPR: Chụp và nhận diện biển số xe
    LPR->>Backend: Trả về kết quả nhận diện
    Backend->>App: Xác nhận check-in thành công
    App->>User: Thông báo check-in thành công
    App->>User: Hiển thị vị trí đỗ xe
    
    Note over User,App: Sau khi sử dụng dịch vụ
    
    User->>Staff: Yêu cầu lấy xe
    Staff->>App: Quét mã QR hoặc thẻ NFC
    App->>Backend: Gửi thông tin check-out
    Backend->>LPR: Chụp và xác minh biển số xe
    LPR->>Backend: Trả về kết quả xác minh
    Backend->>App: Tính toán phí đỗ xe
    App->>User: Hiển thị phí đỗ xe (nếu chưa thanh toán trước)
    User->>App: Thanh toán (nếu cần)
    App->>Backend: Cập nhật trạng thái thanh toán
    Backend->>App: Xác nhận check-out thành công
    App->>User: Thông báo check-out thành công
```

### 1.4. Đánh giá và phản hồi

```mermaid
sequenceDiagram
    participant User as Người dùng
    participant App as Ứng dụng
    participant Backend as Backend API
    
    User->>App: Truy cập lịch sử đỗ xe
    App->>Backend: Yêu cầu lịch sử đỗ xe
    Backend->>App: Trả về lịch sử đỗ xe
    App->>User: Hiển thị lịch sử đỗ xe
    User->>App: Chọn bãi đỗ để đánh giá
    App->>User: Hiển thị form đánh giá
    User->>App: Nhập đánh giá và xếp hạng
    App->>Backend: Gửi đánh giá
    Backend->>App: Xác nhận đánh giá thành công
    App->>User: Thông báo đánh giá thành công
```

## 2. Luồng chủ bãi đỗ xe (Parking Owner)

### 2.1. Thiết lập bãi đỗ xe

```mermaid
sequenceDiagram
    participant Owner as Chủ bãi đỗ
    participant App as Ứng dụng
    participant Backend as Backend API
    participant Map as Map Service
    
    Owner->>App: Đăng nhập với tài khoản chủ bãi
    App->>Backend: Xác thực tài khoản
    Backend->>App: Xác nhận đăng nhập thành công
    App->>Owner: Hiển thị dashboard chủ bãi
    Owner->>App: Chọn "Thêm bãi đỗ mới"
    App->>Owner: Hiển thị form thêm bãi đỗ
    Owner->>App: Nhập thông tin bãi đỗ
    App->>Map: Đánh dấu vị trí trên bản đồ
    Map->>App: Trả về tọa độ
    Owner->>App: Cấu hình giá và thời gian hoạt động
    Owner->>App: Thiết lập số lượng chỗ đỗ
    App->>Backend: Gửi thông tin bãi đỗ mới
    Backend->>App: Xác nhận tạo bãi đỗ thành công
    App->>Owner: Hiển thị thông tin bãi đỗ mới
```

### 2.2. Quản lý bãi đỗ xe

```mermaid
sequenceDiagram
    participant Owner as Chủ bãi đỗ
    participant App as Ứng dụng
    participant Backend as Backend API
    participant DB as Database
    
    Owner->>App: Truy cập dashboard chủ bãi
    App->>Backend: Yêu cầu thông tin bãi đỗ
    Backend->>DB: Truy vấn dữ liệu
    DB->>Backend: Trả về dữ liệu
    Backend->>App: Trả về thông tin bãi đỗ
    App->>Owner: Hiển thị thông tin tổng quan
    
    Note over Owner,App: Các tác vụ quản lý
    
    Owner->>App: Chọn "Quản lý nhân viên"
    App->>Backend: Yêu cầu danh sách nhân viên
    Backend->>App: Trả về danh sách nhân viên
    App->>Owner: Hiển thị danh sách nhân viên
    
    Owner->>App: Chọn "Cài đặt giá"
    App->>Backend: Yêu cầu cài đặt giá hiện tại
    Backend->>App: Trả về cài đặt giá
    App->>Owner: Hiển thị form cài đặt giá
    Owner->>App: Cập nhật cài đặt giá
    App->>Backend: Gửi cài đặt giá mới
    Backend->>App: Xác nhận cập nhật thành công
    
    Owner->>App: Chọn "Báo cáo doanh thu"
    App->>Backend: Yêu cầu dữ liệu doanh thu
    Backend->>App: Trả về dữ liệu doanh thu
    App->>Owner: Hiển thị báo cáo doanh thu
```

### 2.3. Quản lý license

```mermaid
sequenceDiagram
    participant Owner as Chủ bãi đỗ
    participant App as Ứng dụng
    participant Backend as Backend API
    participant License as License Service
    participant Payment as Payment Gateway
    
    Owner->>App: Truy cập quản lý license
    App->>Backend: Yêu cầu thông tin license
    Backend->>License: Kiểm tra trạng thái license
    License->>Backend: Trả về thông tin license
    Backend->>App: Trả về thông tin license
    App->>Owner: Hiển thị thông tin license
    
    Note over Owner,App: Khi license sắp hết hạn
    
    Backend->>App: Gửi thông báo license sắp hết hạn
    App->>Owner: Hiển thị thông báo
    Owner->>App: Chọn "Gia hạn license"
    App->>Backend: Yêu cầu thông tin gia hạn
    Backend->>App: Trả về các gói gia hạn
    App->>Owner: Hiển thị các gói gia hạn
    Owner->>App: Chọn gói và phương thức thanh toán
    App->>Payment: Xử lý thanh toán
    Payment->>App: Xác nhận thanh toán thành công
    App->>Backend: Gửi thông tin gia hạn
    Backend->>License: Cập nhật thời hạn license
    License->>Backend: Xác nhận cập nhật thành công
    Backend->>App: Trả về thông tin license mới
    App->>Owner: Hiển thị xác nhận gia hạn thành công
```

## 3. Luồng nhân viên bãi đỗ xe (Parking Staff)

### 3.1. Quản lý xe ra/vào

```mermaid
sequenceDiagram
    participant Staff as Nhân viên
    participant App as Ứng dụng
    participant Backend as Backend API
    participant NFC as NFC Reader
    participant LPR as License Plate Recognition
    participant DB as Database
    
    Staff->>App: Đăng nhập với tài khoản nhân viên
    App->>Backend: Xác thực tài khoản
    Backend->>App: Xác nhận đăng nhập thành công
    App->>Staff: Hiển thị màn hình quản lý xe
    
    Note over Staff,App: Xử lý xe vào bãi
    
    Staff->>App: Chọn "Xe vào"
    App->>Staff: Yêu cầu quét thẻ NFC hoặc chụp biển số
    Staff->>NFC: Quét thẻ NFC
    NFC->>App: Trả về thông tin thẻ
    Alt Hoặc sử dụng camera
        Staff->>App: Chụp biển số xe
        App->>LPR: Gửi ảnh để nhận diện
        LPR->>App: Trả về kết quả nhận diện
    End
    App->>Backend: Gửi thông tin xe vào
    Backend->>DB: Lưu thông tin xe vào
    Backend->>App: Xác nhận ghi nhận thành công
    App->>Staff: Hiển thị thông tin xe và thời gian vào
    
    Note over Staff,App: Xử lý xe ra bãi
    
    Staff->>App: Chọn "Xe ra"
    App->>Staff: Yêu cầu quét thẻ NFC hoặc chụp biển số
    Staff->>NFC: Quét thẻ NFC
    NFC->>App: Trả về thông tin thẻ
    Alt Hoặc sử dụng camera
        Staff->>App: Chụp biển số xe
        App->>LPR: Gửi ảnh để nhận diện
        LPR->>App: Trả về kết quả nhận diện
    End
    App->>Backend: Gửi thông tin xe ra
    Backend->>DB: Truy vấn thông tin xe vào
    DB->>Backend: Trả về thông tin xe vào
    Backend->>App: Tính toán thời gian và chi phí
    App->>Staff: Hiển thị thông tin chi phí
    Staff->>App: Xác nhận thanh toán
    App->>Backend: Cập nhật trạng thái thanh toán
    Backend->>DB: Lưu thông tin xe ra và thanh toán
    Backend->>App: Xác nhận ghi nhận thành công
    App->>Staff: Hiển thị thông báo thành công
```

### 3.2. Hoạt động offline

```mermaid
sequenceDiagram
    participant Staff as Nhân viên
    participant App as Ứng dụng
    participant LocalDB as SQLite Local DB
    participant Backend as Backend API
    participant DB as Database
    
    Note over Staff,App: Khi mất kết nối Internet
    
    Staff->>App: Cố gắng ghi nhận xe vào/ra
    App--xBackend: Kiểm tra kết nối (thất bại)
    App->>Staff: Thông báo đang hoạt động ở chế độ offline
    
    Note over Staff,App: Xử lý xe vào bãi (offline)
    
    Staff->>App: Chọn "Xe vào" (offline)
    App->>Staff: Yêu cầu quét thẻ NFC hoặc chụp biển số
    Staff->>App: Cung cấp thông tin xe
    App->>LocalDB: Lưu thông tin xe vào
    LocalDB->>App: Xác nhận lưu thành công
    App->>Staff: Hiển thị thông tin xe và thời gian vào
    
    Note over Staff,App: Xử lý xe ra bãi (offline)
    
    Staff->>App: Chọn "Xe ra" (offline)
    App->>Staff: Yêu cầu quét thẻ NFC hoặc chụp biển số
    Staff->>App: Cung cấp thông tin xe
    App->>LocalDB: Truy vấn thông tin xe vào
    LocalDB->>App: Trả về thông tin xe vào
    App->>Staff: Hiển thị thông tin chi phí
    Staff->>App: Xác nhận thanh toán
    App->>LocalDB: Lưu thông tin xe ra và thanh toán
    LocalDB->>App: Xác nhận lưu thành công
    App->>Staff: Hiển thị thông báo thành công
    
    Note over Staff,App: Khi có kết nối Internet trở lại
    
    App-->>Backend: Phát hiện kết nối đã được khôi phục
    App->>LocalDB: Truy vấn dữ liệu chưa đồng bộ
    LocalDB->>App: Trả về dữ liệu chưa đồng bộ
    App->>Backend: Đồng bộ dữ liệu offline
    Backend->>DB: Cập nhật dữ liệu từ thiết bị
    DB->>Backend: Xác nhận cập nhật thành công
    Backend->>App: Xác nhận đồng bộ thành công
    App->>LocalDB: Đánh dấu dữ liệu đã đồng bộ
    App->>Staff: Thông báo đã đồng bộ dữ liệu thành công
```

## 4. Luồng quản lý bãi đỗ xe (Parking Manager)

### 4.1. Giám sát bãi đỗ xe

```mermaid
sequenceDiagram
    participant Manager as Quản lý
    participant App as Ứng dụng
    participant Backend as Backend API
    participant DB as Database
    participant Analytics as Analytics Service
    
    Manager->>App: Đăng nhập với tài khoản quản lý
    App->>Backend: Xác thực tài khoản
    Backend->>App: Xác nhận đăng nhập thành công
    App->>Manager: Hiển thị dashboard quản lý
    
    Manager->>App: Chọn "Giám sát trực tiếp"
    App->>Backend: Yêu cầu dữ liệu trực tiếp
    Backend->>DB: Truy vấn trạng thái hiện tại
    DB->>Backend: Trả về trạng thái hiện tại
    Backend->>App: Cập nhật dữ liệu theo thời gian thực
    App->>Manager: Hiển thị trạng thái bãi đỗ theo thời gian thực
    
    Manager->>App: Chọn "Thống kê bãi đỗ"
    App->>Backend: Yêu cầu dữ liệu thống kê
    Backend->>Analytics: Truy vấn dữ liệu phân tích
    Analytics->>Backend: Trả về dữ liệu phân tích
    Backend->>App: Trả về dữ liệu thống kê
    App->>Manager: Hiển thị thống kê (biểu đồ, số liệu)
```

### 4.2. Nhận thông báo

```mermaid
sequenceDiagram
    participant Manager as Quản lý
    participant App as Ứng dụng
    participant Backend as Backend API
    participant Notification as Notification Service
    
    Note over Backend,Notification: Hệ thống phát hiện sự kiện quan trọng
    
    Backend->>Notification: Tạo thông báo
    Notification->>App: Gửi push notification
    App->>Manager: Hiển thị thông báo
    
    Manager->>App: Mở thông báo
    App->>Backend: Yêu cầu chi tiết thông báo
    Backend->>App: Trả về chi tiết thông báo
    App->>Manager: Hiển thị chi tiết thông báo
    
    Manager->>App: Thực hiện hành động từ thông báo
    App->>Backend: Gửi hành động phản hồi
    Backend->>App: Xác nhận xử lý thành công
    App->>Manager: Hiển thị kết quả xử lý
```

## 5. Luồng chung

### 5.1. Đồng bộ hóa dữ liệu offline

```mermaid
sequenceDiagram
    participant App as Ứng dụng
    participant LocalDB as SQLite Local DB
    participant Backend as Backend API
    participant DB as Database
    
    Note over App,LocalDB: Phát hiện mất kết nối
    
    App--xBackend: Kiểm tra kết nối (thất bại)
    App->>LocalDB: Lưu trữ dữ liệu offline
    
    Note over App,Backend: Phát hiện có kết nối trở lại
    
    App-->>Backend: Kiểm tra kết nối (thành công)
    App->>LocalDB: Lấy danh sách dữ liệu chưa đồng bộ
    LocalDB->>App: Trả về dữ liệu chưa đồng bộ
    
    App->>Backend: Gửi dữ liệu để đồng bộ
    Backend->>DB: Kiểm tra xung đột dữ liệu
    
    Alt Không có xung đột
        DB->>Backend: Xác nhận không có xung đột
        Backend->>DB: Cập nhật dữ liệu
        DB->>Backend: Xác nhận cập nhật thành công
        Backend->>App: Thông báo đồng bộ thành công
        App->>LocalDB: Đánh dấu dữ liệu đã đồng bộ
    Else Có xung đột dữ liệu
        DB->>Backend: Thông báo có xung đột
        Backend->>App: Gửi thông tin xung đột
        App->>LocalDB: Lưu thông tin xung đột
        App->>App: Hiển thị tùy chọn giải quyết xung đột
    End
```

### 5.2. Quản lý license

```mermaid
sequenceDiagram
    participant User as Chủ bãi đỗ
    participant App as Ứng dụng
    participant Backend as Backend API
    participant License as License Service
    participant Notification as Notification Service
    
    Note over License,Notification: Hệ thống kiểm tra license hàng ngày
    
    License->>Backend: Kiểm tra license sắp hết hạn
    Backend->>Notification: Tạo thông báo cho license sắp hết hạn
    Notification->>App: Gửi push notification
    App->>User: Hiển thị thông báo license sắp hết hạn
    
    User->>App: Mở thông báo
    App->>Backend: Yêu cầu thông tin license
    Backend->>License: Truy vấn thông tin license
    License->>Backend: Trả về thông tin license
    Backend->>App: Trả về thông tin license
    App->>User: Hiển thị thông tin license và tùy chọn gia hạn
    
    User->>App: Chọn gia hạn license
    App->>Backend: Yêu cầu thông tin gói gia hạn
    Backend->>App: Trả về thông tin gói gia hạn
    App->>User: Hiển thị các gói gia hạn
    User->>App: Chọn gói và thanh toán
    App->>Backend: Gửi thông tin thanh toán
    Backend->>License: Cập nhật thời hạn license
    License->>Backend: Xác nhận cập nhật thành công
    Backend->>App: Thông báo gia hạn thành công
    App->>User: Hiển thị thông báo gia hạn thành công
```

## Kết luận

Các luồng ứng dụng được thiết kế để cung cấp trải nghiệm người dùng mượt mà và liền mạch, đồng thời đảm bảo hệ thống hoạt động hiệu quả ngay cả khi mất kết nối internet. Luồng ứng dụng được tối ưu hóa cho từng đối tượng người dùng khác nhau, đảm bảo đáp ứng đầy đủ các yêu cầu chức năng của dự án AI Parking.

---
*Cập nhật: Đã bổ sung các luồng mới liên quan đến quét thẻ NFC, xử lý nhận diện biển số xe offline, đồng bộ hóa dữ liệu khi có kết nối trở lại, quản lý và gia hạn license.*
