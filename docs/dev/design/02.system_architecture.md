# Kiến trúc hệ thống AI Parking

Tài liệu này mô tả chi tiết kiến trúc hệ thống của ứng dụng AI Parking, bao gồm các thành phần frontend, backend, cơ sở dữ liệu và các dịch vụ bên ngoài.

## 1. Tổng quan kiến trúc

AI Parking được thiết kế theo kiến trúc microservices kết hợp với clean architecture, tạo ra một hệ thống có khả năng mở rộng cao, dễ bảo trì và hiệu suất tốt. Hệ thống bao gồm các thành phần chính sau:

```ascii
┌─────────────────────────────────────────────────────────────────┐
│                       Client Applications                        │
│                                                                 │
│   ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌──────┐   │
│   │  Mobile   │    │   Web     │    │ Admin     │    │ IoT  │   │
│   │   App     │    │ Dashboard │    │ Portal    │    │ Devs │   │
│   └─────┬─────┘    └─────┬─────┘    └─────┬─────┘    └──┬───┘   │
└─────────┼───────────────┼───────────────┼──────────────┼────────┘
          │               │               │              │
          └───────────────┼───────────────┼──────────────┘
                          │               │
                          ▼               ▼
┌─────────────────────────────────────────────────────────────────┐
│                          API Gateway                            │
│                                                                 │
│   ┌───────────────┐  ┌───────────────┐  ┌───────────────────┐   │
│   │ Authentication│  │ Rate Limiting │  │ Request Routing   │   │
│   └───────────────┘  └───────────────┘  └───────────────────┘   │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Microservices                            │
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────┐  │
│  │   User   │ │  Parking │ │  Booking │ │ Payment  │ │License│  │
│  │ Service  │ │ Service  │ │ Service  │ │ Service  │ │Service│  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └───────┘  │
│                                                                 │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────┐ ┌──────┐  │
│  │Notification│ │  AI     │ │Analytics │ │ Reporting │ │ Sync │  │
│  │ Service  │ │ Service  │ │ Service  │ │ Service   │ │Service│ │
│  └──────────┘ └──────────┘ └──────────┘ └───────────┘ └──────┘  │
└──────────────────────────────┬──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Data Storage Layer                         │
│                                                                 │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │
│  │PostgreSQL │  │  Redis    │  │ MongoDB   │  │ Object    │     │
│  │(Main DB)  │  │ (Cache)   │  │(Analytics)│  │ Storage   │     │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘     │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                     External Services                           │
│                                                                 │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐     │
│  │ Maps API  │  │ Payment   │  │ Push      │  │ Email     │     │
│  │          │  │ Gateways  │  │ Services  │  │ Services  │     │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

## 2. Thành phần kiến trúc

### 2.1. Frontend (Client Applications)

#### 2.1.1. Ứng dụng di động (Flutter)

- **Kiến trúc**: Clean Architecture + BLoC Pattern
- **Các layer chính**:
  - **Presentation Layer**: UI Components, Screens, Widgets
  - **Business Logic Layer**: BLoC (Business Logic Components)
  - **Domain Layer**: Use Cases, Entities, Repository Interfaces
  - **Data Layer**: Repositories, Data Sources, Models

```ascii
┌─────────────────────────────────────────────────────────┐
│                  Presentation Layer                     │
│  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ Screens │  │ Widgets  │  │ Pages    │  │ UI Utils │  │
│  └─────────┘  └──────────┘  └──────────┘  └──────────┘  │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                  Business Logic Layer                   │
│  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │  BLoCs  │  │ Cubits   │  │ States   │  │ Events   │  │
│  └─────────┘  └──────────┘  └──────────┘  └──────────┘  │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                    Domain Layer                         │
│  ┌─────────┐  ┌──────────┐  ┌────────────┐             │
│  │ Entities│  │ Use Cases │  │ Repository │             │
│  │         │  │          │  │ Interfaces │             │
│  └─────────┘  └──────────┘  └────────────┘             │
└───────────────────────────┬─────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                     Data Layer                          │
│  ┌──────────┐  ┌────────────┐  ┌────────┐  ┌─────────┐  │
│  │Repository│  │ Data       │  │ Models │  │ Local   │  │
│  │Implement │  │ Sources    │  │        │  │ Storage │  │
│  └──────────┘  └────────────┘  └────────┘  └─────────┘  │
└─────────────────────────────────────────────────────────┘
```

#### 2.1.2. Web Dashboard

- **Công nghệ**: React/Angular + TypeScript
- **Mục đích**: Quản lý và giám sát bãi đỗ xe dành cho chủ bãi và quản lý

#### 2.1.3. Admin Portal

- **Công nghệ**: React/Angular + TypeScript
- **Mục đích**: Quản lý toàn bộ hệ thống, người dùng, thanh toán, và license

#### 2.1.4. IoT Devices

- **Công nghệ**: Embedded Systems, ESP32, Raspberry Pi
- **Mục đích**: Kết nối với camera, thiết bị đọc thẻ NFC, cảm biến

### 2.2. API Gateway

- **Công nghệ**: Nginx, Kong, or AWS API Gateway
- **Chức năng**:
  - Xác thực và phân quyền
  - Giới hạn tốc độ truy cập (Rate limiting)
  - Định tuyến yêu cầu (Request routing)
  - Cân bằng tải (Load balancing)
  - API Documentation với Swagger/OpenAPI

### 2.3. Backend Microservices

#### 2.3.1. User Service

- **Chức năng**: Quản lý người dùng, xác thực, phân quyền
- **Endpoints chính**:
  - `/api/auth/register` - Đăng ký người dùng mới
  - `/api/auth/login` - Đăng nhập
  - `/api/auth/refresh-token` - Làm mới token
  - `/api/users/{id}` - Quản lý thông tin người dùng
  - `/api/roles` - Quản lý vai trò và quyền hạn

#### 2.3.2. Parking Service

- **Chức năng**: Quản lý bãi đỗ xe, chỗ đỗ xe, và trạng thái
- **Endpoints chính**:
  - `/api/parking-lots` - Quản lý bãi đỗ xe
  - `/api/parking-lots/{id}/spaces` - Quản lý chỗ đỗ xe
  - `/api/parking-lots/{id}/status` - Theo dõi trạng thái bãi đỗ
  - `/api/parking-lots/nearby` - Tìm bãi đỗ gần nhất

#### 2.3.3. Booking Service

- **Chức năng**: Quản lý đặt chỗ và lịch sử đỗ xe
- **Endpoints chính**:
  - `/api/bookings` - Tạo và quản lý đặt chỗ
  - `/api/bookings/{id}/status` - Cập nhật trạng thái đặt chỗ
  - `/api/parking-history` - Lịch sử đỗ xe
  - `/api/check-in` - Xử lý xe vào bãi
  - `/api/check-out` - Xử lý xe ra bãi

#### 2.3.4. Payment Service

- **Chức năng**: Xử lý thanh toán và quản lý giao dịch
- **Endpoints chính**:
  - `/api/payments` - Tạo và quản lý thanh toán
  - `/api/payment-methods` - Quản lý phương thức thanh toán
  - `/api/invoices` - Quản lý hóa đơn
  - `/api/transactions` - Lịch sử giao dịch

#### 2.3.5. License Service

- **Chức năng**: Quản lý license sử dụng hệ thống
- **Endpoints chính**:
  - `/api/licenses` - Quản lý license
  - `/api/licenses/{id}/status` - Kiểm tra trạng thái license
  - `/api/licenses/renew` - Gia hạn license
  - `/api/license-packages` - Quản lý gói license

#### 2.3.6. Notification Service

- **Chức năng**: Gửi thông báo đẩy, email, và SMS
- **Endpoints chính**:
  - `/api/notifications` - Quản lý thông báo
  - `/api/notifications/settings` - Cài đặt thông báo
  - `/api/push-tokens` - Quản lý token thiết bị

#### 2.3.7. AI Service

- **Chức năng**: Xử lý nhận diện biển số xe, dự báo nhu cầu, tối ưu hóa
- **Endpoints chính**:
  - `/api/license-plate-recognition` - Nhận diện biển số xe
  - `/api/demand-forecast` - Dự báo nhu cầu đỗ xe
  - `/api/revenue-optimization` - Tối ưu hóa doanh thu

#### 2.3.8. Analytics Service

- **Chức năng**: Phân tích dữ liệu và tạo insight
- **Endpoints chính**:
  - `/api/analytics/usage` - Phân tích sử dụng
  - `/api/analytics/revenue` - Phân tích doanh thu
  - `/api/analytics/trends` - Phân tích xu hướng

#### 2.3.9. Reporting Service

- **Chức năng**: Tạo báo cáo và thống kê
- **Endpoints chính**:
  - `/api/reports` - Quản lý báo cáo
  - `/api/reports/revenue` - Báo cáo doanh thu
  - `/api/reports/usage` - Báo cáo sử dụng
  - `/api/reports/export` - Xuất báo cáo

#### 2.3.10. Sync Service

- **Chức năng**: Đồng bộ hóa dữ liệu offline
- **Endpoints chính**:
  - `/api/sync` - Đồng bộ dữ liệu
  - `/api/sync/status` - Kiểm tra trạng thái đồng bộ
  - `/api/sync/conflicts` - Quản lý xung đột đồng bộ

### 2.4. Data Storage Layer

#### 2.4.1. PostgreSQL (Main Database)

- **Mục đích**: Lưu trữ dữ liệu cấu trúc chính của ứng dụng
- **Dữ liệu chính**:
  - Thông tin người dùng
  - Thông tin bãi đỗ xe
  - Đặt chỗ và lịch sử đỗ xe
  - Giao dịch thanh toán
  - License và cài đặt hệ thống

#### 2.4.2. Redis (Cache)

- **Mục đích**: Lưu trữ dữ liệu tạm thời và cache
- **Dữ liệu chính**:
  - Session và token
  - Kết quả truy vấn thường xuyên
  - Trạng thái bãi đỗ theo thời gian thực
  - Hàng đợi thông báo

#### 2.4.3. MongoDB (Analytics)

- **Mục đích**: Lưu trữ dữ liệu phân tích và log
- **Dữ liệu chính**:
  - Log hệ thống
  - Dữ liệu phân tích
  - Dữ liệu lịch sử dài hạn
  - Dữ liệu không cấu trúc

#### 2.4.4. Object Storage (S3, Minio)

- **Mục đích**: Lưu trữ hình ảnh và tệp tin
- **Dữ liệu chính**:
  - Hình ảnh biển số xe
  - Hình ảnh bãi đỗ
  - Tài liệu và báo cáo

#### 2.4.5. SQLite (Local Storage)

- **Mục đích**: Lưu trữ dữ liệu offline trên thiết bị di động
- **Dữ liệu chính**:
  - Dữ liệu cần thiết cho hoạt động offline
  - Lịch sử giao dịch chưa đồng bộ
  - Cache dữ liệu cục bộ

### 2.5. External Services

#### 2.5.1. Maps API

- **Nhà cung cấp**: Google Maps, Mapbox
- **Chức năng**:
  - Hiển thị bãi đỗ trên bản đồ
  - Tính toán khoảng cách và thời gian di chuyển
  - Chỉ đường đến bãi đỗ

#### 2.5.2. Payment Gateways

- **Nhà cung cấp**: Stripe, PayPal, Local Payment Providers
- **Chức năng**:
  - Xử lý thanh toán
  - Quản lý thẻ tín dụng
  - Thanh toán định kỳ cho license

#### 2.5.3. Push Notification Services

- **Nhà cung cấp**: Firebase Cloud Messaging, OneSignal
- **Chức năng**:
  - Gửi thông báo đẩy
  - Quản lý token thiết bị
  - Theo dõi tương tác thông báo

#### 2.5.4. Email Services

- **Nhà cung cấp**: SendGrid, Mailchimp, AWS SES
- **Chức năng**:
  - Gửi email xác thực
  - Thông báo và cảnh báo
  - Báo cáo định kỳ

## 3. Giao tiếp giữa các thành phần

### 3.1. Giao thức giao tiếp

- **REST API**: Giao tiếp chính giữa client và server
- **WebSockets**: Cập nhật dữ liệu theo thời gian thực
- **gRPC**: Giao tiếp giữa các microservices
- **Message Queue**: Xử lý các tác vụ bất đồng bộ

### 3.2. Mô hình giao tiếp

```ascii
┌───────────┐          ┌─────────────┐          ┌───────────────┐
│  Client   │          │API Gateway/ │          │ Microservices │
│           │◄─REST───►│ Load Balancer│◄─gRPC───►│               │
└─────┬─────┘          └─────────────┘          └───────┬───────┘
      │                                                 │
      │                                                 │
      │                                                 │
      │                                                 │
      ▼                                                 ▼
┌─────────────┐                                 ┌───────────────┐
│WebSocket    │                                 │Message Queue  │
│Server       │◄───────────────────────────────►│(Kafka/RabbitMQ)│
└─────────────┘                                 └───────────────┘
```

### 3.3. Xử lý sự kiện

- **Event-driven Architecture**: Sử dụng Kafka hoặc RabbitMQ
- **Các sự kiện chính**:
  - Đăng ký người dùng mới
  - Tạo đặt chỗ mới
  - Check-in/Check-out xe
  - Thanh toán thành công
  - Cảnh báo bãi đỗ gần đầy
  - License sắp hết hạn

## 4. Xử lý offline và đồng bộ hóa

### 4.1. Lưu trữ dữ liệu offline

- Sử dụng SQLite để lưu trữ dữ liệu cần thiết trên thiết bị
- Cache dữ liệu thường xuyên sử dụng
- Lưu trữ mô hình AI nhẹ cho nhận diện biển số offline

### 4.2. Chiến lược đồng bộ hóa

- **Đồng bộ tự động**: Khi có kết nối internet
- **Đồng bộ theo lịch**: Định kỳ kiểm tra và đồng bộ
- **Đồng bộ thủ công**: Người dùng chủ động đồng bộ

### 4.3. Xử lý xung đột

- **Chiến lược Last-Write-Wins**: Phiên bản mới nhất thắng
- **Merge Changes**: Kết hợp các thay đổi nếu có thể
- **Conflict Resolution UI**: Cho phép người dùng giải quyết xung đột

## 5. Bảo mật

### 5.1. Xác thực và phân quyền

- **JWT (JSON Web Tokens)**: Cho xác thực API
- **OAuth 2.0/OpenID Connect**: Cho SSO và xác thực bên thứ ba
- **Role-based Access Control (RBAC)**: Phân quyền dựa trên vai trò

### 5.2. Bảo mật dữ liệu

- **Mã hóa dữ liệu nhạy cảm**: Thông tin thanh toán, thông tin cá nhân
- **HTTPS/TLS**: Mã hóa dữ liệu trong quá trình truyền tải
- **Mã hóa dữ liệu lưu trữ**: Mã hóa dữ liệu trên thiết bị và cơ sở dữ liệu

### 5.3. Bảo mật API

- **API Keys**: Cho các dịch vụ bên ngoài
- **Rate Limiting**: Ngăn chặn tấn công DDoS
- **IP Whitelisting**: Cho admin API
- **WAF (Web Application Firewall)**: Bảo vệ chống tấn công web

## 6. Khả năng mở rộng và Hiệu suất

### 6.1. Chiến lược mở rộng

- **Horizontal Scaling**: Thêm nhiều instance cho microservices
- **Vertical Scaling**: Tăng tài nguyên cho các instance hiện có
- **Database Sharding**: Phân chia dữ liệu theo khu vực địa lý

### 6.2. Caching

- **Application Cache**: Cache kết quả truy vấn thường xuyên
- **CDN**: Cho tài nguyên tĩnh
- **Distributed Cache**: Redis cho cache phân tán

### 6.3. Tối ưu hóa hiệu suất

- **Lazy Loading**: Tải dữ liệu khi cần thiết
- **Pagination**: Phân trang kết quả
- **Background Processing**: Xử lý tác vụ nặng trong background
- **Image Optimization**: Tối ưu hóa hình ảnh cho thiết bị di động

## 7. Giám sát và Logging

### 7.1. Monitoring

- **Prometheus**: Thu thập metrics
- **Grafana**: Hiển thị dashboard
- **Healthchecks**: Kiểm tra tình trạng dịch vụ
- **Alerting**: Cảnh báo khi có sự cố

### 7.2. Logging

- **ELK Stack**: Elasticsearch, Logstash, Kibana
- **Structured Logging**: Log có cấu trúc
- **Distributed Tracing**: OpenTelemetry/Jaeger
- **Log Aggregation**: Tổng hợp log từ nhiều service

## 8. Chiến lược triển khai

### 8.1. Containerization

- **Docker**: Đóng gói ứng dụng
- **Kubernetes**: Orchestration và quản lý container
- **Helm Charts**: Quản lý deployment

### 8.2. CI/CD

- **GitHub Actions/Jenkins**: Tự động hóa build và test
- **ArgoCD**: GitOps cho Kubernetes
- **Blue/Green Deployment**: Triển khai không downtime

### 8.3. Môi trường

- **Development**: Phát triển
- **Staging**: Kiểm thử
- **Production**: Sản phẩm
- **Disaster Recovery**: Khôi phục sau sự cố

## Kết luận

Kiến trúc hệ thống AI Parking được thiết kế để đáp ứng các yêu cầu về khả năng mở rộng, hiệu suất cao, và tính sẵn sàng. Kiến trúc microservices giúp phát triển và triển khai độc lập các thành phần, trong khi các chiến lược offline và đồng bộ hóa đảm bảo ứng dụng hoạt động liền mạch ngay cả khi không có kết nối internet.

---
*Cập nhật: Đã bổ sung các thành phần mới liên quan đến xử lý offline, nhận diện biển số xe AI, đồng bộ hóa dữ liệu khi có kết nối trở lại, quản lý license và thông báo gia hạn.*
